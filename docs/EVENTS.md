# üéÇ CakeReact: Events System

–°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞—Å—à–∏—Ä—è—Ç—å –ª–æ–≥–∏–∫—É –º–æ–¥–µ–ª–µ–π –∏ –ø–ª–∞–≥–∏–Ω–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–¥–∞.

## 1. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (CakePHP Style)
–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ª—é–±–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ –ª—é–±–æ–π —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –º–æ–¥–µ–ª–µ–π:
- `Model.beforeSave`: –ü–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º.
- `Model.afterSave`: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
- `Model.beforeDelete`: –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º.
- `Model.afterDelete`: –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è.

### –ü—Ä–∏–º–µ—Ä –ø–æ–¥–ø–∏—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ø–ª–∞–≥–∏–Ω–µ –∏–ª–∏ –≤ App.jsx):
```javascript
import { CakeReact } from '@cakereact/core';

CakeReact.on('Model.afterSave', ({ model, result, isNew }) => {
    console.log(`–ú–æ–¥–µ–ª—å ${model.table} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å: ${isNew}`);
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (Toast)
});
```
## 2. –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ö—É–∫–∏ –≤ –ú–æ–¥–µ–ª—è—Ö
–í—ã –º–æ–∂–µ—Ç–µ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä—è–º–æ –≤ –∫–ª–∞—Å—Å–µ –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏:
```javascript
export class ProductModel extends BaseModel {
    table = 'products';

    async beforeSave(data) {
        // –ù–∞–ø—Ä–∏–º–µ—Ä, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–∞–≥–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
        if (data.name) {
            data.slug = data.name.toLowerCase().replace(/ /g, '-');
        }
    }
}
```

## 3. –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `CakeReact` –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—É—é —à–∏–Ω—É —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–≤–æ–∏—Ö –Ω—É–∂–¥:
```javascript
// –û—Ç–ø—Ä–∞–≤–∫–∞
CakeReact.emit('App.myCustomEvent', { user: 'Admin' });

// –ü–æ–ª—É—á–µ–Ω–∏–µ
CakeReact.on('App.myCustomEvent', (data) => { ... });
```
### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–ª–µ—Ç–µ
–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º. –¢–∞–∫ –∫–∞–∫ –æ–±—ä–µ–∫—Ç `event.data` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø–æ —Å—Å—ã–ª–∫–µ, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∫ –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–π–¥–µ—Ç –≤ –ë–î.

```javascript
CakeReact.on('Model.beforeSave', async (event) => {
    const { model, data } = event;

    if (model.table === 'products') {
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∫ —à—Ç—Ä–∏—Ö–∫–æ–¥—É
        data.barcode = 'SKU-' + data.barcode;
    }
});
```

## –û—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
–ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è —Ä–µ—à–∏—Ç, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –Ω–µ–ª—å–∑—è, –æ–Ω –º–æ–∂–µ—Ç –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `stopped`:
```javascript
CakeReact.on('Model.beforeSave', (event) => {
    if (!event.data.name) {
        console.error("–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!");
        event.stopped = true; // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç
    }
});
```

## –°–æ–±—ã—Ç–∏—è —É–¥–∞–ª–µ–Ω–∏—è (Delete Lifecycle)

### `beforeDelete(id)`
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –∫ –ë–î. 
- **–õ–æ–∫–∞–ª—å–Ω–æ**: –í–µ—Ä–Ω–∏—Ç–µ `false`, —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å.
- **–ì–ª–æ–±–∞–ª—å–Ω–æ**: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `event.stopped = true`.

### `afterDelete(id)`
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è. –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –ª–æ–≥–æ–≤.

```javascript
// –ü—Ä–∏–º–µ—Ä: —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î
CakeReact.on('Model.afterDelete', async ({ model, id }) => {
    if (model.table === 'products') {
        // –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑ Storage
    }
});
```

## –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ? (–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–≤ –º–æ–¥–µ–ª–∏)
–¢—ã –º–æ–∂–µ—à—å –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —É–¥–∞–ª—è—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –µ—Å–ª–∏ –≤ –Ω–µ–π –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã.
```javascript
// models/CategoryModel.js
async beforeDelete(id) {
    const { count } = await this.db
        .from('products')
        .select('*', { count: 'exact', head: true })
        .eq('category_id', id);

    if (count > 0) {
        alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –≤ –∫–æ—Ç–æ—Ä–æ–π –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã!");
        return false; // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç
    }
}
```

### –ü—Ä–∏–º–µ—Ä 2: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–≤ –ø–ª–∞–≥–∏–Ω–µ)
–ü–ª–∞–≥–∏–Ω –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ —É–¥–∞–ª–∏–ª –∑–∞–ø–∏—Å—å.
```javascript
CakeReact.on('Model.beforeDelete', async (event) => {
    console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ${event.id} –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ${event.subject.table}`);
});
```

### –í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å:

–í –º–µ—Ç–æ–¥–µ `save` –º—ã –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏ –≤ —Å–æ–±—ã—Ç–∏–µ `data` (–≤–µ—Å—å –æ–±—ä–µ–∫—Ç), –∞ –≤ `delete` –º—ã –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ `id`. 
–≠—Ç–æ –ª–æ–≥–∏—á–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É –Ω–∞—Å —á–∞—Å—Ç–æ –Ω–µ—Ç –ø–æ–¥ —Ä—É–∫–æ–π –≤—Å–µ–π —Å—É—â–Ω–æ—Å—Ç–∏. 
–ù–æ –µ—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤ `beforeDelete` –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤–µ—Å—å –æ–±—ä–µ–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–µ `is_protected`), —Ç–µ–±–µ –ø—Ä–∏–¥–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞—Ç—å `select` –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–∞ `delete`, –Ω–æ —ç—Ç–æ –∑–∞–º–µ–¥–ª–∏—Ç —Ä–∞–±–æ—Ç—É. 
–í 90% —Å–ª—É—á–∞–µ–≤ ID –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

---

